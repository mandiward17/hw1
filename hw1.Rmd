---
title: "hw1"
author: "Mandi Ward, Zach Farley & Esme Castro"
date: "2/14/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gghighlight)
library(scales)
library(colorspace)
library(ggplot2)
library(ggrepel)
library(ggtext)
```

## Reading in the data
```{r}
transit_cost <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-01-05/transit_cost.csv')

# first read in the data
d <- readr::read_csv(here::here("data", "crime.csv"))

# write it out as a parquet file
arrow::write_parquet(d, here::here("data", "crime.parquet"))

# read it in again
crime <- arrow::read_parquet(here::here("data", "crime.parquet")) %>% 
  janitor::clean_names()
```

## Question 1
```{r reproduce-plot}
country_codes <- countrycode::codelist %>% 
  select(country_name = country.name.en, country = ecb)


transit_cost$real_cost <- as.double(transit_cost$real_cost) # convert chr to dbl

df <- merge(x = transit_cost, y = country_codes,
           by = "country", all = TRUE)                 ## merged datasets

df <- df[df$country %in% names(which(table(
  df$country)>=3)), ]                            ## removed occurrences > 3

q1 <- df %>% 
  group_by(country_name) %>% 
  summarise(mean = mean(real_cost),
            se = sd(real_cost) / sqrt(n()))

q1 %>% 
  filter(country_name != "NA") %>% 
  mutate(country_name = fct_reorder(country_name, mean)) %>% 
  ggplot(aes(mean, country_name)) +
  geom_linerange(aes(xmin = mean - 1.96 * se, xmax = mean + 1.96 * se),
                 color = "grey40") +
  geom_point(color = "cornflowerblue") +
  scale_x_continuous(labels = comma, limits = c(0, 35000), expand = c(0, 0)) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_line(color = "gray85"),
        axis.title.x = element_text(face = "bold", size = 12),
        axis.title.y = element_text(face = "bold", size = 12),
        plot.title = element_text(hjust = -.45, size = 14),
        plot.caption = element_text(hjust = .5, size = 10)) +
  labs(x = "Real Cost (In millions of dollars)",
       y = "Country",
       title = "Cost to build transit systems vary across countries",
       caption = "Data provided through #tidytuesday by the Transit Costs Project")

## some data missing error bars (look at France for example)
## above comment has something to do with the width of the geom_linerange
## Also aspect ratio should be smaller on x-axis
```

## Question 2
```{r uncertainty-plot}
err <- q1 %>% 
  filter(country_name != "NA") %>% 
  mutate(country_name = fct_reorder(country_name, mean)) %>% 
  ggplot(aes(mean, country_name)) +
    geom_errorbarh(aes(xmin = mean - 2.58 * se, xmax = mean + 2.58 * se,
                 color = "99%"), width = 0.2, size = 0.8) + # 99% CI
    geom_errorbarh(aes(xmin = mean - 1.96 * se, xmax = mean + 1.96 * se,
                 color = "95%"), width = 0.2, size = 1.2) +  # 95% CI
    geom_errorbarh(aes(xmin = mean - 1.65 * se, xmax = mean + 1.65 * se,
                 color = "90%"), width = 0.2, size = 1.6) +   # 90% CI
  geom_point() +
  scale_x_continuous(labels = comma, limits = c(0, 35000), expand = c(0, 0)) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(color = "gray85"),
        axis.title.x = element_text(face = "bold", size = 12),
        axis.title.y = element_text(face = "bold", size = 12),
        plot.title = element_text(hjust = -.45, size = 14),
        plot.subtitle = element_text(hjust = -.16),
        plot.caption = element_text(hjust = .5, size = 10)) +
  labs(x = "Real Cost (In millions of dollars)",
       y = "Country",
       title = "Cost to build transit systems vary across countries",
       subtitle = "Uncertainty of cost is provided",
       caption = "Data provided through #tidytuesday by the Transit Costs Project")

err +
  scale_color_manual("Confidence Interval",
                     values = c("#50af5b",
                                lighten("#50af5b", .5),
                                lighten("#50af5b", .8)))
# just missing a few country's lines for some reason. Need to extend x-axis?
# it has something to do with the width in geom_errorbarh()
```


*Zach trying to fix error bars*
```{r}
q1 %>% 
  filter(country_name != "NA") %>% 
  mutate(country_name = fct_reorder(country_name, mean)) %>% 
  ggplot(aes(mean, country_name)) +
  geom_linerange(aes(xmin = mean - 1.96 * se, xmax = mean + 1.96 * se),
                 color = "grey40") +
  geom_point(color = "cornflowerblue") +
  scale_x_continuous(labels = comma, expand = c(0, 0)) +
  coord_cartesian(xlim = c(0, 35000)) + # this is what I added! I took away the limits = in scale_x_continuous
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_line(color = "gray85"),
        axis.title.x = element_text(face = "bold", size = 12),
        axis.title.y = element_text(face = "bold", size = 12),
        plot.title = element_text(hjust = -.45, size = 14),
        plot.caption = element_text(hjust = .5, size = 10)) +
  labs(x = "Real Cost (In millions of dollars)",
       y = "Country",
       title = "Cost to build transit systems vary across countries",
       caption = "Data provided through #tidytuesday by the Transit Costs Project")

## some data missing error bars (look at France for example)
## above comment has something to do with the width of the geom_linerange
## Also aspect ratio should be smaller on x-axis
```

```{r}

```


## Question 5
*__Seemed WAY to easy to do once I understood what the actual question was. Need to check and make sure I actually completed all parts of the question. Data Viz looks correct, just need to make sure it shows correct data. __*
```{r}
model_data <- crime %>% 
  mutate(neighborhood_id = relevel(factor(neighborhood_id), ref = "barnum"))

m <- glm(is_crime ~ neighborhood_id, 
         data = model_data,
         family = "binomial")

tidied <- broom::tidy(m)
```

```{r}
barnum_west <- tidied %>% 
  filter(term == "neighborhood_idbarnum-west")

barnum_west1 <- data.frame(
   x = qnorm(ppoints(16),
       mean = barnum_west$estimate,
       sd = barnum_west$std.error)
 ) %>% 
   mutate(less_crime = ifelse(x<=0, 
                              "#866892", 
                              "#24A981"))

ggplot(barnum_west1, aes(x)) +
  theme_minimal() +
  geom_dotplot(aes(fill = less_crime), 
               binwidth = 0.035) +
  scale_fill_identity(guide = "none") +
  geom_vline(xintercept = 0.000,
             color = "red",
             size = 1.5) +
  scale_y_continuous(name = "",
                     breaks = NULL
) +
  scale_x_continuous(name = "Difference in log odds of a crime being committed") +
  labs(title = "Probability of differential crime rates between neighborhoods",
        subtitle = "<span style = 'color: #866892'>**Barnum West**</span> compared to <span style = 'color: #24A981'>**Barnum**</span>",
       caption = "Each ball represents 5% probability") +
  theme(plot.subtitle = element_markdown())
```




